#include <stdio.h>#include <string.h>#include <stdlib.h>#include <limits.h>#include <netcdf.h>#include <math.h>#include "wofost.h"#include "extern.h"/* Handle errors by printing an error message and exiting with a * non-zero status. */#define ERR(e) {printf("Error: %s\n", nc_strerror(e)); exit(2);}/* set decimals */#define roundz(x,d) ((floor(((x)*pow(10,d))+.5))/pow(10,d))int GetMeteoData(Weather* Meteo){    int i;    size_t j, k;        int retval;    size_t pstart[3], pcount[3];        float Svap_Tmax, Svap_Tmin, Svap;    float ***variable;    float *data;        for (i = 0; i < WEATHER_NTYPES; i++) {                // Fill variable        if (i == WEATHER_TMIN) {            variable = &Tmin;        } else if (i == WEATHER_TMAX) {            variable = &Tmax;        } else if (i == WEATHER_RADIATION) {            variable = &Radiation;        } else if (i == WEATHER_RAIN) {            variable = &Rain;        } else if (i == WEATHER_WINDSPEED) {            variable = &Windspeed;        } else if (i == WEATHER_VAPOUR) {            variable = &Vapour;        }                data = malloc(NLongitude * NLatitude * sizeof(*data));        if(data == NULL){            fprintf(stderr, "Could not malloc");            exit(0);         }                pstart[0] = Day;        pstart[1] = 0;        pstart[2] = 0;        pcount[0] = 1;        pcount[1] = NLatitude;        pcount[2] = NLongitude;        if((retval = nc_get_vara_float(Meteo->ncid[i], Meteo->varid[i],                                        pstart, pcount, data)))            ERR(retval);                for (k = 0; k < NLatitude; k++) {            for (j = 0; j < NLongitude; j++) {                if (Mask[j][k] == 1) {                    (*variable)[j][k] = data[k * NLongitude + j];                } else {                    (*variable)[j][k] = -99;                }            }        }        free(data);    }        // adjust data    for (j = 0; j < NLongitude; j++) {        for (k = 0; k < NLatitude; k++) {            if (Mask[j][k] == 1) {                                if (strcmp(Meteo->units[WEATHER_TMIN], "C") == 0) {                    Tmin[j][k] = roundz(Tmin[j][k], 1);                } else if (strcmp(Meteo->units[WEATHER_TMIN], "K") == 0) {                    Tmin[j][k] = roundz(Tmin[j][k] - 273.15, 1);                } else {                    fprintf(stderr, "Unknown units for TMIN, "                                    "please use: C or K");                    exit(2);                }                                if (strcmp(Meteo->units[WEATHER_TMAX], "C") == 0) {                    Tmax[j][k] = roundz(Tmax[j][k], 1);                } else if (strcmp(Meteo->units[WEATHER_TMAX], "K") == 0) {                    Tmax[j][k] = roundz(Tmax[j][k] - 273.15, 1);                } else {                    fprintf(stderr, "Unknown units for TMAX, "                                    "please use: C or K");                    exit(2);                }                                if (strcmp(Meteo->units[WEATHER_RADIATION], "Wm-2") == 0) {                    Radiation[j][k]  = 1000 * roundz(86.400 * Radiation[j][k], 1);                } else {                    fprintf(stderr, "Unknown units for RADIATION, "                                    "please use: Wm-2");                    exit(2);                }                                if (strcmp(Meteo->units[WEATHER_RAIN], "mmday-1") == 0) {                    Rain[j][k] = roundz(0.1 * Rain[j][k], 2);                } else if (strcmp(Meteo->units[WEATHER_RAIN], "kgm-2s-1") == 0) {                    Rain[j][k] = roundz(8640 * Rain[j][k], 2);                } else {                    fprintf(stderr, "Unknown units for RAIN, "                                    "please use: mmday-1 or kgm-2s-1");                    exit(2);                }                                if (strcmp(Meteo->units[WEATHER_WINDSPEED], "ms-1") == 0) {                    Windspeed[j][k] = roundz(Windspeed[j][k], 1);                } else {                    fprintf(stderr, "Unknown units for WINDSPEED, "                                    "please use: ms-1");                    exit(2);                }                                if (strcmp(Meteo->units[WEATHER_VAPOUR], "kPa") == 0) {                    Vapour[j][k] = roundz(10 * Vapour[j][k], 2);                } else if (strcmp(Meteo->units[WEATHER_VAPOUR], "%") == 0) {                    Svap_Tmax = 6.108 * exp((17.27 * Tmax[j][k]) / (237.3 + Tmax[j][k]));                    Svap_Tmin = 6.108 * exp((17.27 * Tmin[j][k]) / (237.3 + Tmin[j][k]));                    Svap = (Svap_Tmax + Svap_Tmin) / 2.;                    Vapour[j][k] = roundz(0.01 * Vapour[j][k] * Svap, 2);                } else {                        fprintf(stderr, "Unknown units for VAPOUR, "                                        "please use: %% or kPa");                    exit(2);                }            }        }    }        return 1;}